{% macro rep_css_color(rep) %}
hsl({{ '%i, 100%%, 90%%'|format(100 - 100*rep) if rep is defined else '0, 0%, 70%'}})
{% endmacro -%}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ title }} - NERD web</title>
  <!-- jQuery, jQuery UI and other libraries -->
  {#<link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-2.2.0.js"></script>
  <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>#}
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
  {#<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>#}
  <script src="{{ url_for('static', filename='jquery.multiselect.js') }}"></script>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='jquery.multiselect.css') }}">
  <!-- local stylesheets -->
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='flags.css') }}">
  
<script>
var ROOT = "{{ url_for('main') }}";

function create_event_table(data) { /* data are "dataset" field of a DOM node with "data-" attributes set */
  var cats = data.cats.split(",");
  var dates = data.dates.split(",");
  var table = [];
  var table_rows = data.table.split(";");
  for (i = 0; i < table_rows.length; i++) {
    table.push(table_rows[i].split(","));
  }
  var nodes = data.nodes.split(",");
  
  var content = "<table><tr><th></th><th>";
  content += cats.join("</th><th>");
  content += "</th></tr>";
  for (i = 0; i < dates.length; i++) {
    content += "<tr><th>"+dates[i]+"</th><td>";
    content += table[i].join("</td><td>");
    content += "</td></tr>";
  }
  content += "</table>";
  content += "<b>Nodes (" + nodes.length + "):</b> " + nodes.join(", ");
  return content;
}

$(function() {
  /* jQuery UI tooltip at:
     - country flags (with name of the country)
     - "events" table cells
     - AS number
  */
  $( document ).tooltip({
    items: ".country [title], .asn [title], .tag[title]",
    track: false,
    show: false,
    hide: false,
    position: {my: "left bottom", at: "left-7px top-2px", collision: "flip"},
    content: function() { return $(this).attr('title'); } /* This is needed to allow HTML in tooltip text */
  });
  /* jQuery UI tooltip at "events" cell with event table */
  $( ".events" ).tooltip({
    items: ".events",
    track: false,
    show: false,
    hide: false,
    position: {my: "left bottom", at: "left-7px top-2px", collision: "flip"},
    content: function() { return create_event_table(this.dataset) }, /*$(".tooltip_event_table", this).html(); },*/
    tooltipClass: "events_tooltip"
  });
  /* jQuery UI tooltip at times with "timeago" */
  $( ".time" ).tooltip({
    items: ".time",
    track: false,
    show: false,
    hide: false,
    content: function() { return moment($(this).text()).fromNow() },
    position: {my: "left bottom", at: "left-7px top-2px", collision: "flip"}
  });
});
</script>
</head>

<body>
{% if ac("statusbox") %}
{% block status %} {# TODO make as "macro" #}
<div id="status-block">
<img class="refresh-spinner" src="{{ url_for('static', filename='spin.gif') }}">
<p><b>Status</b> (refreshing <a id="status_refresh_toggle" href="#" onclick="toggle_status_refresh(); return false;">disabled</a>)</p>
<table><tr><td>IPs in DB:</td><td><span id="status-ips">??</span></td></tr></table>
<table><tr><td>Data disk usage:</td><td><span id="status-disk-usage">??</span></td></tr></table>
<table>
<tr><td>Event queue (IDEA files):</td><td><span id="status-idea-queue">??</span></td></tr>
<tr><td colspan="2"><div id="status-idea-queue-bar" class="queue"><div></div></div></td></tr>
</table>
<table>
<tr><td>Request queue:</td><td><span id="status-req-queue">??</span></td></tr>
<tr><td colspan="2"><div id="status-req-queue-bar" class="queue"><div></div></div></td></tr>
</table>
<table>
<tr><td>Requests/second</td><td><span id="status-reqs">??</span></td></tr>
<tr><td colspan="2"><canvas id="status-reqs-plot" width="100" height="40" style="width: 100%; height: 40px"></canvas></td></tr>
</table>
<script type="text/javascript" src="{{ url_for('static', filename='smoothie.js') }}"></script> {# Load library for plotting stream-data (reqs/s) #}
<script>
// resize the canvas to 100% width
$("#status-reqs-plot").attr("width", $("#status-reqs-plot").css("width"));
// Create reqs/s chart
var smoothie = new SmoothieChart({millisPerPixel:200, interpolation:'linear', 
    grid: {fillStyle:'#ffffff', millisPerLine:5000, verticalSections:3},
    labels: {fillStyle:'#000000'},
    minValue: 0, maxValue: 300
});
smoothie.streamTo(document.getElementById("status-reqs-plot"));
smoothie.stop();
var reqs_timeseries = new TimeSeries();
smoothie.addTimeSeries(reqs_timeseries, {lineWidth: 2, strokeStyle:'#00c000', fillStyle: 'rgba(0,128,0,0.25)'});
</script>
<script>
var refresh_status_enable = false; // Enable/disable refresh status
var refreshing_status = false; // Whether refresh is in progress (to avoid multiple parallel calls it they are very slow and refresh interval is small)

function toggle_status_refresh() {
    if (refresh_status_enable) {
        refresh_status_enable=false;
        $("#status_refresh_toggle").text("disabled");
        smoothie.stop();
    }
    else {
        refresh_status_enable=true;
        $("#status_refresh_toggle").text("enabled");
        smoothie.start();
    }
}

// AJAX request to get NERD status information
function refresh_status(force=false) {
    if (!force && (!refresh_status_enable || refreshing_status)) {
        return;
    }
    refreshing_status = true;
    $("#status-block .refresh-spinner").css('visibility', 'visible');
    $.getJSON(
        "{{ url_for('get_status') }}",
        function(data) {
            $("#status-ips").text(data.ips);
            $("#status-reqs").text(data.requests_processed);
            $("#status-disk-usage").text(data.disk_usage);
            $("#status-idea-queue").text(data.idea_queue);
            // Set width of bar and its color
            var bar_width = (data.idea_queue * 100 / 10000);
            $("#status-idea-queue-bar div").css('width', bar_width + "%");
            if (bar_width < 50) {
                $("#status-idea-queue-bar div").css('background-color', '#0c0');
            }
            else if (bar_width < 75) {
                $("#status-idea-queue-bar div").css('background-color', '#ea0');
            }
            else {
                $("#status-idea-queue-bar div").css('background-color', '#c00');
            }
            
            $("#status-req-queue").text(data.req_queue);
            // Set width of bar and its color
            var bar_width = (data.req_queue * 100 / 1000);
            if (bar_width > 100) {
                bar_width = 100;
            }
            $("#status-req-queue-bar div").css('width', bar_width + "%");
            if (bar_width < 50) {
                $("#status-req-queue-bar div").css('background-color', '#0c0');
            }
            else if (bar_width < 75) {
                $("#status-req-queue-bar div").css('background-color', '#ea0');
            }
            else {
                $("#status-req-queue-bar div").css('background-color', '#c00');
            }
            // Add data to res/s plot
            reqs_timeseries.append(new Date().getTime(), data.requests_processed);
        }
    )
    .always(function() {
        refreshing_status = false;
        $("#status-block .refresh-spinner").css('visibility', 'hidden');
    });
}

// Set automatic refresh every 5s
var status_refresh_timer = window.setInterval(refresh_status, 1000);
// Run refresh once on load
$(function() { refresh_status(true) });
</script>
</div>
{% endblock %}
{% endif %}

{% block header %}
<div id="header">
 <div id="corner-logo">
  <img src="{{ url_for('static', filename='nerd_logo_simple_86.png') }}" width="86" height="30">
 </div>
 <div id="navigation">
  <a href="{{ url_for('ips') }}">List of IPs</a> | <a href="{{ url_for('ip') }}">IP detail</a>
 </div> 
 <div id="login">
  {% if not user %}
  Log in using:
  {%- for method_name, params in config.login.methods.items() -%}
    <a href="{{ url_for('login_'+method_name) }}">{{ params.display }}</a>
  {%- endfor -%}
  {% else %}
  Logged in:<a href="{{ url_for('account_info') }}" class="username">{{ user.id }}{% if user.name %} ({{ user.name }}){% endif %}</a>&bull;<a href="{{ url_for('logout') }}">Log out</a>
  {% endif %}
 </div>
</div>
{% endblock %}

<div id="content">
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      {# if category starts with "safe ", mark message as safe and skip html escaping #}
      {% if category[:5] == "safe " %}
        {% set message = message|safe %}
        {% set category = category[5:] %}
      {% endif %}
      <div class="msg {{ category }}">{{ message }}<a class="close" href="#" onclick="$(this).parent().hide(); return false;">&#x274C;</a></div>
    {% endfor %}
  {% endif %}
{% endwith %}

{% if not user %}
<div id="login-prompt-outer">
<img id="login-logo" src="{{ url_for('static', filename='nerd_logo_350.png') }}" width="350" height="179" alt="NERD logo">
<div id="login-box">
<h1>You are not logged in.</h1>
<p>Please, log in using the links in the top-right corner.</p>
</div>
</div>
<div id="login-arrow">&#x2191;</div>
{% else %}
{% block body %}{% endblock %}
{% endif %}
</div>

</body>
</html>