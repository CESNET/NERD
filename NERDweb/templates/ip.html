{% extends "layout.html" %}
{% block body %}

<h1>{{ ip._id }}</h1>

{# Note: The onsubmit script ovverrides funcionality of Submit button to put IP address to custom URL #}
<form id="ip_form" onsubmit="window.location='{{ url_for('ip') }}'+$('#ip_form #ip').val(); return false;">
  {# form.csrf_token #}
  {{ form.ip.label }} {{ form.ip(size=30) }}
  <input type="submit">
</form>

{% if not ip or not ac('ipsearch') %}
  {# Print nothing if no IP was passed #}
{% elif not ipinfo %}
  <hr>
  <p class="msg info notfound">IP '{{ form.ip.data }}' not in database.</p>
{% else %}

<hr>

<div class="ip-info">
<p class="header"><span class="ip">{{ ip }}</span><span class="hostname">{{ ipinfo.hostname|reverse if ipinfo.hostname else '' }}</span></p>

<dl class="attrs">
{% for attr,val in ipinfo|dictsort %}
 {% if attr == "_id" %}
  {# pass #}
 {% elif attr == "events" %}
  <dt>events ({{val.total}})</dt>
  <dd><dl>
   {% for date,cats in val|dictsort %}
    {% if date != 'total' %}
     <dt>{{date}}</dt><dd><dl>
      {% for cat,val in cats|dictsort %}
       {% if cat != 'nodes' %}
        {{cat}}: {{val}}<br>
       {% endif %}
      {% endfor %}
      nodes: {{cats.nodes|join(', ')}}<br>
     </dl></dd>
    {% endif %}
   {% endfor %}
  </dl></dd>
 {% elif attr == "geo" %}
  <dt>geo</dt><dd><span class="country">
    <a href="http://country.io/{{val.ctry|lower}}/">
    <span class="flag flag-{{val.ctry|lower}}"></span>{{ ctrydata.names.get(val.ctry, '?') }}</a></span>
    {{ ', '+val.city if val.city else '' }}
  </dd>
 {% elif attr == "hostname" %}
  <dt>hostname</dt>
  <dd>{{ val|reverse if val else '(null)'}}</dd>
 {% elif attr == "bl" %}
  <dt>blacklists</dt>
  <dd><dl>
   {% for name,times in val|dictsort %}
    <dt>{{name}}</dt><dd>{{times|map('datetime','%Y-%m-%d %H:%M')|join(', ')}}</dd>
   {% endfor %}
  </dl></dd>
 {% elif attr == "as_maxmind" %}
  <dt>ASN (MaxMind DB)</dt><dd>{{ val.num }} {{ val.description }}</dd>
 {% elif attr == "as_rv" %}
  <dt>ASN (routeviews.org & bgplookingglass.com)</dt><dd>{{ val.num }} {{ val.description }}</dd>
 {% else %}
  <dt>{{ attr }}</dt><dd>{{ val }}</dd>
 {% endif %}
{% endfor %}
</dl>

<p id="event-details"><span class="caption">Event details</span> <span class="counts">({{ num_events|safe }})</span>
{%- if config.mentat_url and ac('mentat') %}<span class="mentat-link">Search in <a href="{{config.mentat_url.replace('$IP', ip)}}">Mentat</a></span>{% endif %}
</p>
{% for event in events %}
 <p>{{ event }}</p>
{% endfor %}

</div>
{% endif %}{# if not found #}

{% endblock %}
